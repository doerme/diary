# HTTP redirect

重定向与负载均衡是共存的， 重定向部署一般都带有某些形式的负载均衡。对于客户端来说，服务器，代理，网关，缓存都是服务端，一般来说重定向会将客户端的请求重定向到压力最小的服务器上去，就像将所有需要加油的车移动到最近的加油站去。代理缓存就会避免建立一条昂贵代价的路径到服务器上去。

## HTTP redirect
客户端首先发送一个请求到代理服务器上，代理服务器会发送一个重定向（302,301..）请求给客户端，客户端使用重定向请求提供的域名重新发送一个请求， 这样可以做一点简单的负载均衡，但是使用 HTTP 重定向有几个缺点：1.如果提供重定向的服务器出现故障，那么整个服务就会奔溃，2.客户端增加了往返时延，因为多了一次请求，3. 为了计算最小负荷的服务器，所需要的计算量可能与直接提供页面的计算量一样。

## DNS redirect
使用 DNS 解析程序，这个程序可以是本地的 DNS 解析程序也可以使用远程的 DNS 服务器，将关联到一个域的 IP 地址经过简单的（轮询）或是复杂的（计算）计算之后得出最小负载的服务器，然后返回这个服务器的　IP 地址。
可以使用最简单的 DNS 轮转方法，也就是在服务器集群上，简单地根据访问次序来返回物理服务器地址。不考虑服务器与客户端之间的距离问题。
但是这个方法的缺点在于有可能会被缓存，我们知道 DNS 是会有 DNS 缓存的，也就是说在一个客户端上，它有可能会长时间连接到同一个服务器上，简单的轮询无法均衡单个客户端的请求，但是可以比较好的均衡多个客户端的请求。
如果是使用算法则可以使用 最小负载算法（将最小负载的服务器放到前面去），故障屏蔽（通过监听网络将出现故障的服务器的地址屏蔽掉（绕过）），邻接路由算法（返回距离客户端最近的服务器的地址）
运行着这些算法的 DNS 服务器是在内容提供者管理下的一个 DNS 权威服务器，但是权威服务器在做 DNS 负载均衡的时候是使用本地 DNS 服务器的地址而不是使用客户端的 IP 地址。

## route redirect
使用任播寻址，也就是说将多台服务器的 IP 地址都标记为同一个 IP 地址，然后向路由器网络广告自己是一个路由器。web 服务器会通过路由通信协议，与周边的骨干路由器通信，当客户端的请求来的的时候，将请求转发到离客户端最近的那个服务器上。

## IP mac redirect
也就是说通过设置离客户端最近的那个交换机，设置将来自某个 mac 地址的某个端口的数据（比如来自 80 端口）全部转发到一个代理缓存服务器上，其他数据就还是按原来传输，然后代理服务器就负责缓存新鲜度检查，如果过期则向原服务器请求新的文件。

## IP redirect
在交换机的上游添加代理将目标 IP 地址转化为目标代理的 IP 地址，这样就可以将客户端的请求全部转发到代理上去，但是如果使用全替换（源 IP 地址更换成代理的 IP 地址）这样服务器会不知道客户端的 IP， 但是如果使用半替换（也就是保留客户端 IP）这样需要对客户端与服务端之间的网络有一定的控制。

## Porxy redirect
第一，可以通过客户端显式配置，配置客户端访问的代理服务器地址，但是缺点就在于当代理服务器崩溃，客户端的网络连接会因此受到影响，并且如果网络架构需要进行修改，那么很难通知所有的用户进行浏览器代理设置。
第二，利用 PAC 文件，自动地为浏览器提供访问 url，浏览器设置访问提供 PAC 文件的服务器地址，当重启的时候自动获取 PAC 文件对应的 url。其实 PAC 文件就是一个 javascript 文件，它是用来区分客户端的地域的，当客户端与指定的域名同一个域的时候，那么就访问原始服务器，其他的访问代理。
第三，使用 web 代理自动发现协议。首先使用 WPAD 协议发现 PAC 的 CURL， 然后使用这个 CURL 获取 PAC 文件，通过 PAC 文件返回的地址，发送 http 请求到地址所指向的服务器上。
accpet: application/x-ns-proxy-autoconfig

## cache redirect
WCCP, WCCP 服务组其实是一组路由器加上目标缓存，当客户端的请求分组发送到这一组路由器上的时候，路由器会将分组打包，发送到缓存上去， 当缓存不可用的时候，可以将分组重新发布到网络中去，继续转发，它可以做负载均衡，因为几个服务器之间可以用心跳包来告诉服务组自己的活动状态，分组可以在持续发送心跳包的缓存之间负载均衡。
ICP 是缓存对象发现协议，它建立在 UDP 上，当访问请求来的时候，它会发送一个 UDP 询问请求，询问缓存中是否有特定的 url， 如果有则返回 hit，无则返回 miss，
然后会同级代理询问，如果同级代理都没有命中则访问上一级代理。
CARP 与 ICP 类似，只是 CRAP 维护了一组服务器，中间的缓存代理可以将客户端的请求通过一个确定代理服务器的位置的散列函数计算（包含计算代理服务器的负载量），来做负载均衡， CRAP 要维护一个代理服务器列表而 ICP 不需要。当一个代理服务器崩溃或故障，需要改写配置。
HTCP 也就是加强版的 ICP ，因为 ICP 是 HTTP/0.9 规定的，只有资源的 url，没有缓存策略，HTCP 可以向兄弟代理询问资源并修改缓存策略。与 ICP 的区别在于请求与响应细节上。


